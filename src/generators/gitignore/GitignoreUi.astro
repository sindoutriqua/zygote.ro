---
import type { Generator } from "../types";

interface Props {
    generator: Generator;
}

const { generator } = Astro.props;
---

<div class="generator-container">
    <div class="input-panel">
        <form id="generator-form">
            {
                generator.inputs.map((input) => (
                    <div class="form-group" data-name={input.name}>
                        <label for={input.name}>{input.label}</label>

                        {input.type === "text" && (
                            <input
                                type="text"
                                name={input.name}
                                id={input.name}
                                placeholder={input.placeholder}
                                value={input.defaultValue || ""}
                                required={input.required}
                            />
                        )}

                        {input.type === "textarea" && (
                            <textarea
                                name={input.name}
                                id={input.name}
                                placeholder={input.placeholder}
                                rows="4"
                                required={input.required}
                            >
                                {input.defaultValue || ""}
                            </textarea>
                        )}

                        {input.type === "select" && (
                            <select name={input.name} id={input.name}>
                                {input.options?.map((opt) => (
                                    <option
                                        value={opt}
                                        selected={opt === input.defaultValue}
                                    >
                                        {opt}
                                    </option>
                                ))}
                            </select>
                        )}

                        {input.type === "checkbox" && (
                            <div class="checkbox-group" id={input.name}>
                                {input.options?.map((opt) => (
                                    <label class="checkbox-label">
                                        <input
                                            type="checkbox"
                                            name={input.name}
                                            value={opt}
                                            checked={
                                                Array.isArray(
                                                    input.defaultValue,
                                                ) &&
                                                input.defaultValue.includes(opt)
                                            }
                                        />
                                        <span class="checkbox-text">{opt}</span>
                                    </label>
                                ))}
                            </div>
                        )}
                    </div>
                ))
            }
        </form>
    </div>

    <div class="preview-panel">
        <div class="preview-header">
            <div class="file-tabs" id="file-tabs">
                <!-- Tabs will be injected here -->
            </div>
            <div class="header-actions">
                <button id="copy-btn" class="btn-copy" aria-label="Copy code">
                    <span class="btn-icon">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><rect
                                x="9"
                                y="9"
                                width="13"
                                height="13"
                                rx="2"
                                ry="2"></rect><path
                                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                            ></path></svg
                        >
                    </span>
                    <span class="btn-text">Copy</span>
                </button>
            </div>
        </div>
        <div class="preview-content">
            <pre><code id="preview-code" /></pre>
        </div>
    </div>
</div>

<script>
    import { gitignoreGenerator } from "./generator";

    const form = document.getElementById("generator-form") as HTMLFormElement;
    const previewCode = document.getElementById("preview-code");
    const copyBtn = document.getElementById("copy-btn");
    const tabsContainer = document.getElementById("file-tabs");

    // State
    let currentFiles: { filename: string; content: string }[] = [];
    let activeFileIndex = 0;

    function getFormData() {
        const formData = new FormData(form);
        const data: Record<string, any> = {};

        formData.forEach((value, key) => {
            const checkboxGroup = form.querySelector(
                `.checkbox-group[id="${key}"]`,
            );

            if (checkboxGroup) {
                if (!data[key]) {
                    data[key] = formData.getAll(key);
                }
            } else {
                data[key] = value;
            }
        });
        return data;
    }

    function updatePreview() {
        if (!form || !previewCode) return;

        const data = getFormData();
        const result = gitignoreGenerator.generate(data);

        // Handle new multi-file output
        if (result.files) {
            currentFiles = result.files;
        } else {
            const legacy = result as any;
            currentFiles = [
                {
                    filename: legacy.filename || ".gitignore",
                    content: legacy.content || "",
                },
            ];
        }

        renderTabs();
        showFile(activeFileIndex);
    }

    function renderTabs() {
        if (!tabsContainer) return;

        tabsContainer.innerHTML = "";
        currentFiles.forEach((file, index) => {
            const btn = document.createElement("button");
            btn.className = `tab-btn ${index === activeFileIndex ? "active" : ""}`;
            btn.textContent = file.filename;
            btn.onclick = () => {
                activeFileIndex = index;
                renderTabs();
                showFile(index);
            };
            tabsContainer.appendChild(btn);
        });
    }

    function showFile(index: number) {
        if (!previewCode || !currentFiles[index]) return;
        if (index >= currentFiles.length) activeFileIndex = 0;
        previewCode.textContent = currentFiles[activeFileIndex].content;
    }

    // Initial update
    updatePreview();

    // Listen for changes
    form?.addEventListener("input", updatePreview);
    form?.addEventListener("change", updatePreview);

    // Copy functionality
    copyBtn?.addEventListener("click", async () => {
        if (!previewCode?.textContent) return;

        try {
            await navigator.clipboard.writeText(previewCode.textContent);

            const btnText = copyBtn.querySelector(".btn-text");
            const btnIcon = copyBtn.querySelector(".btn-icon");

            if (btnText && btnIcon) {
                const originalText = btnText.textContent;
                const originalIconHtml = btnIcon.innerHTML;

                btnText.textContent = "Copied!";
                btnIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                copyBtn.classList.add("success");

                setTimeout(() => {
                    btnText.textContent = originalText;
                    btnIcon.innerHTML = originalIconHtml;
                    copyBtn.classList.remove("success");
                }, 2000);
            }
        } catch (err) {
            console.error("Failed to copy:", err);
        }
    });
</script>

<style>
    .generator-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
    }

    @media (min-width: 768px) {
        .generator-container {
            grid-template-columns: 1fr 1fr;
        }
    }

    /* Input Panel */
    .input-panel {
        background: var(--color-bg);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--color-text);
    }

    input[type="text"],
    textarea,
    select {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        background: var(--color-bg);
        color: var(--color-text);
        font-size: 0.95rem;
        transition: border-color 0.15s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* Checkbox Group */
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--color-surface-alt);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        margin-bottom: 0;
        cursor: pointer;
        font-weight: 400;
    }

    .checkbox-label input {
        margin-right: 0.75rem;
        width: auto;
    }

    .checkbox-text {
        text-transform: capitalize;
    }

    /* Preview Panel */
    .preview-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-height: 80vh;
        background: #1e1e1e;
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--color-border);
        box-shadow:
            0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: rgba(30, 30, 30, 0.8);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
    }

    .file-tabs {
        display: flex;
        gap: 0.25rem;
        overflow-x: auto;
        padding-bottom: 0px;
    }

    .file-tabs::-webkit-scrollbar {
        height: 0;
        width: 0;
        display: none;
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
        color: #94a3b8;
        cursor: pointer;
        border-radius: var(--radius-md);
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tab-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: #e2e8f0;
    }

    .tab-btn.active {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-weight: 600;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Code Preview Area */
    .preview-content {
        flex: 1;
        padding: 1.25rem;
        overflow: auto;
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        color: #e2e8f0;
        scrollbar-width: thin;
        scrollbar-color: #475569 #1e1e1e;
    }

    pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* Copy Button */
    .btn-copy {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-copy:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.2);
    }

    .btn-copy.success {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
        border-color: rgba(16, 185, 129, 0.3);
    }

    .btn-icon {
        display: flex;
        align-items: center;
    }
</style>
